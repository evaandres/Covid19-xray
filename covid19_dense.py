{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Transfer Learning\n",
    "\n",
    "A Convolutional Neural Network (CNN) for image classification is made up of multiple layers that extract features, such as edges, corners, etc; and then use a final fully-connected layer to classify objects based on these features. You can visualize this like this:\n",
    "\n",
    "Convolution > Pool > Convolution > Pool > Flatten | > Fully-Connected \n",
    "\n",
    "             Feature Extraction                       |   Classification\n",
    "\n",
    "*Transfer Learning* is a technique where you can take an existing trained model and re-use its feature extraction layers, replacing its final classification layer with a fully-connected layer trained on your own custom images. With this technique, your model benefits from the feature extraction training that was performed on the base model (which may have been based on a larger training dataset than you have access to) to build a classification model for your own specific set of object classes.\n",
    "\n",
    "How does this help? Well, think of it this way. Suppose you take a professional tennis player and a complete beginner, and try to teach them both how to play raquetball. It's reasonable to assume that the professional tennis player will be easier to train, because many of the underlying skills involved in raquetball are already learned. Similarly, a pre-trained CNN model may be easier to train to classify specific set of objects because it's already learned how to identify the features of common objects, such as edges and corners. Fundamentally, a pre-trained model can be a great way to produce an effective classifier even when you have limited data with which to train it.\n",
    "\n",
    "In this notebook, we'll see how to implement transfer learning for a classification model using Tensorflow.\n",
    "\n",
    "## Import libraries\n",
    "\n",
    "First, let's import the Tensorflow libraries we're going to use."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "!pip install --upgrade azureml-sdk[notebooks,automl,explain]\n",
    "!pip install tensorflow\n",
    "!pip install keras"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import tensorflow\n",
    "from  tensorflow import keras\n",
    "print('TensorFlow version:',tensorflow.__version__)\n",
    "print('Keras version:',keras.__version__)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ready to use Azure ML 1.12.0 to work with ws-eva\n"
     ]
    }
   ],
   "source": [
    "import azureml.core\n",
    "from azureml.core import Workspace\n",
    "\n",
    "# Load the workspace from the saved config file\n",
    "ws = Workspace.from_config()\n",
    "print('Ready to use Azure ML {} to work with {}'.format(azureml.core.VERSION, ws.name))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "trainig folder created\n"
     ]
    }
   ],
   "source": [
    "import os, shutil\n",
    "\n",
    "# Create a folder for the experiment files\n",
    "training_folder = 'covid-training2'\n",
    "os.makedirs(training_folder, exist_ok=True)\n",
    "print(\"trainig folder created\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Preparing the Data\n",
    "Before we can train the model, we need to prepare the data."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "{\n",
      "  \"name\": \"workspaceblobstore\",\n",
      "  \"container_name\": \"azureml-blobstore-3f332d11-9d1e-4d50-9185-08c0c52fad78\",\n",
      "  \"account_name\": \"wseva1634245866\",\n",
      "  \"protocol\": \"https\",\n",
      "  \"endpoint\": \"core.windows.net\"\n",
      "}\n"
     ]
    }
   ],
   "source": [
    "default_ds = ws.get_default_datastore()\n",
    "print(default_ds)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "from azureml.core import Dataset\n",
    "\n",
    "datastore_covid = ws.get_default_datastore()\n",
    "\n",
    "\n",
    "datastore_covid.upload('./covid-img',                                    \n",
    "                        target_path='./covid-img', # Put it in a folder path in the datastore\n",
    "                        overwrite=True, # Replace existing files of the same name\n",
    "                        show_progress=True)\n",
    "    \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "$AZUREML_DATAREFERENCE_f94ffbe93f5f446dbd517a5a5a799c47\n"
     ]
    }
   ],
   "source": [
    "from azureml.core import Dataset\n",
    "\n",
    "datastore_covid = ws.get_default_datastore()\n",
    "\n",
    "data_ref = datastore_covid.path('./covid-img').as_download(path_on_compute='./covid-img')\n",
    "print(data_ref)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found existing cluster, use it.\n"
     ]
    }
   ],
   "source": [
    "from azureml.core.compute import ComputeTarget, AmlCompute\n",
    "from azureml.core.compute_target import ComputeTargetException\n",
    "\n",
    "#cluster_name = \"eva-cluster\"\n",
    "cluster_name = \"ci-eva3\"\n",
    "\n",
    "try:\n",
    "    # Check for existing compute target\n",
    "    compute_cluster = ComputeTarget(workspace=ws, name=cluster_name)\n",
    "    print('Found existing cluster, use it.')\n",
    "except ComputeTargetException:\n",
    "    # If it doesn't already exist, create it\n",
    "    try:\n",
    "        compute_config = AmlCompute.provisioning_configuration(vm_size='STANDARD_DS11_V2', max_nodes=2)\n",
    "        compute_cluster = ComputeTarget.create(ws, cluster_name, compute_config)\n",
    "        compute_cluster.wait_for_completion(show_output=True)\n",
    "    except Exception as ex:\n",
    "        print(ex)\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "2ef0c9a2c8a5497ca8910f563fd66112",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "_HyperDriveWidget(widget_settings={'childWidgetDisplay': 'popup', 'send_telemetry': False, 'log_level': 'INFO'â€¦"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/aml.mini.widget.v1": "{\"status\": \"Canceled\", \"workbench_run_details_uri\": \"https://ml.azure.com/experiments/covid_hyperdrive/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e?wsid=/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourcegroups/RG-eva/workspaces/ws-eva\", \"run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e\", \"run_properties\": {\"run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e\", \"created_utc\": \"2020-08-31T09:20:15.269383Z\", \"properties\": {\"primary_metric_config\": \"{\\\"name\\\": \\\"Accuracy\\\", \\\"goal\\\": \\\"maximize\\\"}\", \"resume_from\": \"null\", \"runTemplate\": \"HyperDrive\", \"azureml.runsource\": \"hyperdrive\", \"platform\": \"AML\", \"ContentSnapshotId\": \"56b0cb1e-41fb-41c9-a954-6f50d534d1e5\"}, \"tags\": {\"_aml_system_max_concurrent_jobs\": \"2\", \"max_concurrent_jobs\": \"2\", \"_aml_system_max_total_jobs\": \"4\", \"max_total_jobs\": \"4\", \"_aml_system_max_duration_minutes\": \"10080\", \"max_duration_minutes\": \"10080\", \"_aml_system_policy_config\": \"{\\\"name\\\": \\\"MEDIANSTOPPING\\\", \\\"properties\\\": {\\\"evaluation_interval\\\": 1, \\\"delay_evaluation\\\": 0}}\", \"policy_config\": \"{\\\"name\\\": \\\"MEDIANSTOPPING\\\", \\\"properties\\\": {\\\"evaluation_interval\\\": 1, \\\"delay_evaluation\\\": 0}}\", \"_aml_system_generator_config\": \"{\\\"name\\\": \\\"GRID\\\", \\\"parameter_space\\\": {\\\"--epochs\\\": [\\\"choice\\\", [[15, 20]]], \\\"--batch_size\\\": [\\\"choice\\\", [[16, 32]]], \\\"--n_1layer\\\": [\\\"choice\\\", [[256, 123]]], \\\"--n_2layer\\\": [\\\"choice\\\", [[123, 60]]], \\\"--learning-rate\\\": [\\\"choice\\\", [[0.0001, 0.001]]]}}\", \"generator_config\": \"{\\\"name\\\": \\\"GRID\\\", \\\"parameter_space\\\": {\\\"--epochs\\\": [\\\"choice\\\", [[15, 20]]], \\\"--batch_size\\\": [\\\"choice\\\", [[16, 32]]], \\\"--n_1layer\\\": [\\\"choice\\\", [[256, 123]]], \\\"--n_2layer\\\": [\\\"choice\\\", [[123, 60]]], \\\"--learning-rate\\\": [\\\"choice\\\", [[0.0001, 0.001]]]}}\", \"_aml_system_primary_metric_config\": \"{\\\"name\\\": \\\"Accuracy\\\", \\\"goal\\\": \\\"maximize\\\"}\", \"primary_metric_config\": \"{\\\"name\\\": \\\"Accuracy\\\", \\\"goal\\\": \\\"maximize\\\"}\", \"_aml_system_platform_config\": \"{\\\"ServiceAddress\\\": \\\"https://westeurope.experiments.azureml.net\\\", \\\"ServiceArmScope\\\": \\\"subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid_hyperdrive\\\", \\\"SubscriptionId\\\": \\\"03712800-fbe1-4639-81d1-4ebb18f06dfc\\\", \\\"ResourceGroupName\\\": \\\"RG-eva\\\", \\\"WorkspaceName\\\": \\\"ws-eva\\\", \\\"ExperimentName\\\": \\\"covid_hyperdrive\\\", \\\"Definition\\\": {\\\"Overrides\\\": {\\\"script\\\": \\\"covid_training_dense169.py\\\", \\\"arguments\\\": [], \\\"target\\\": \\\"ci-eva3\\\", \\\"framework\\\": \\\"Python\\\", \\\"communicator\\\": \\\"None\\\", \\\"maxRunDurationSeconds\\\": null, \\\"nodeCount\\\": 1, \\\"environment\\\": {\\\"name\\\": null, \\\"version\\\": null, \\\"environmentVariables\\\": {\\\"EXAMPLE_ENV_VAR\\\": \\\"EXAMPLE_VALUE\\\"}, \\\"python\\\": {\\\"userManagedDependencies\\\": false, \\\"interpreterPath\\\": \\\"python\\\", \\\"condaDependenciesFile\\\": null, \\\"baseCondaEnvironment\\\": null, \\\"condaDependencies\\\": {\\\"name\\\": \\\"project_environment\\\", \\\"dependencies\\\": [\\\"python=3.6.2\\\", {\\\"pip\\\": [\\\"azureml-defaults\\\", \\\"azureml-dataset-runtime[fuse,pandas]\\\", \\\"tensorflow==2.0.0\\\", \\\"horovod==0.18.1\\\"]}, \\\"keras\\\", \\\"matplotlib\\\", \\\"scikit-learn\\\"], \\\"channels\\\": [\\\"anaconda\\\", \\\"conda-forge\\\"]}}, \\\"docker\\\": {\\\"enabled\\\": true, \\\"baseImage\\\": \\\"mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20200423.v1\\\", \\\"baseDockerfile\\\": null, \\\"sharedVolumes\\\": true, \\\"shmSize\\\": \\\"2g\\\", \\\"arguments\\\": [], \\\"baseImageRegistry\\\": {\\\"address\\\": null, \\\"username\\\": null, \\\"password\\\": null, \\\"registryIdentity\\\": null}, \\\"platform\\\": {\\\"os\\\": \\\"Linux\\\", \\\"architecture\\\": \\\"amd64\\\"}}, \\\"spark\\\": {\\\"repositories\\\": [], \\\"packages\\\": [], \\\"precachePackages\\\": false}, \\\"databricks\\\": {\\\"mavenLibraries\\\": [], \\\"pypiLibraries\\\": [], \\\"rcranLibraries\\\": [], \\\"jarLibraries\\\": [], \\\"eggLibraries\\\": []}, \\\"r\\\": null, \\\"inferencingStackVersion\\\": null}, \\\"history\\\": {\\\"outputCollection\\\": true, \\\"snapshotProject\\\": true, \\\"directoriesToWatch\\\": [\\\"logs\\\"]}, \\\"spark\\\": {\\\"configuration\\\": {\\\"spark.app.name\\\": \\\"Azure ML Experiment\\\", \\\"spark.yarn.maxAppAttempts\\\": 1}}, \\\"hdi\\\": {\\\"yarnDeployMode\\\": \\\"cluster\\\"}, \\\"tensorflow\\\": {\\\"workerCount\\\": 1, \\\"parameterServerCount\\\": 1}, \\\"mpi\\\": {\\\"processCountPerNode\\\": 1}, \\\"paralleltask\\\": {\\\"maxRetriesPerWorker\\\": 0, \\\"workerCountPerNode\\\": 1, \\\"terminalExitCodes\\\": null}, \\\"dataReferences\\\": {}, \\\"data\\\": {}, \\\"outputData\\\": {}, \\\"sourceDirectoryDataStore\\\": null, \\\"amlcompute\\\": {\\\"vmSize\\\": null, \\\"vmPriority\\\": null, \\\"retainCluster\\\": false, \\\"name\\\": null, \\\"clusterMaxNodeCount\\\": 1}}, \\\"TargetDetails\\\": null, \\\"SnapshotId\\\": \\\"56b0cb1e-41fb-41c9-a954-6f50d534d1e5\\\", \\\"TelemetryValues\\\": {\\\"amlClientType\\\": \\\"azureml-sdk-train\\\", \\\"amlClientModule\\\": \\\"[Scrubbed]\\\", \\\"amlClientFunction\\\": \\\"[Scrubbed]\\\", \\\"tenantId\\\": \\\"53a2628b-019a-476a-96c2-6b7acc5973b8\\\", \\\"amlClientRequestId\\\": \\\"139a772a-64c3-4a30-810b-c33d6170b851\\\", \\\"amlClientSessionId\\\": \\\"d77821ef-aefe-4ff4-a37b-ae24c8d6c893\\\", \\\"subscriptionId\\\": \\\"03712800-fbe1-4639-81d1-4ebb18f06dfc\\\", \\\"estimator\\\": \\\"TensorFlow\\\", \\\"samplingMethod\\\": \\\"GRID\\\", \\\"terminationPolicy\\\": \\\"MedianStopping\\\", \\\"primaryMetricGoal\\\": \\\"maximize\\\", \\\"maxTotalRuns\\\": 4, \\\"maxConcurrentRuns\\\": 2, \\\"maxDurationMinutes\\\": 10080, \\\"vmSize\\\": null}}}\", \"platform_config\": \"{\\\"ServiceAddress\\\": \\\"https://westeurope.experiments.azureml.net\\\", \\\"ServiceArmScope\\\": \\\"subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid_hyperdrive\\\", \\\"SubscriptionId\\\": \\\"03712800-fbe1-4639-81d1-4ebb18f06dfc\\\", \\\"ResourceGroupName\\\": \\\"RG-eva\\\", \\\"WorkspaceName\\\": \\\"ws-eva\\\", \\\"ExperimentName\\\": \\\"covid_hyperdrive\\\", \\\"Definition\\\": {\\\"Overrides\\\": {\\\"script\\\": \\\"covid_training_dense169.py\\\", \\\"arguments\\\": [], \\\"target\\\": \\\"ci-eva3\\\", \\\"framework\\\": \\\"Python\\\", \\\"communicator\\\": \\\"None\\\", \\\"maxRunDurationSeconds\\\": null, \\\"nodeCount\\\": 1, \\\"environment\\\": {\\\"name\\\": null, \\\"version\\\": null, \\\"environmentVariables\\\": {\\\"EXAMPLE_ENV_VAR\\\": \\\"EXAMPLE_VALUE\\\"}, \\\"python\\\": {\\\"userManagedDependencies\\\": false, \\\"interpreterPath\\\": \\\"python\\\", \\\"condaDependenciesFile\\\": null, \\\"baseCondaEnvironment\\\": null, \\\"condaDependencies\\\": {\\\"name\\\": \\\"project_environment\\\", \\\"dependencies\\\": [\\\"python=3.6.2\\\", {\\\"pip\\\": [\\\"azureml-defaults\\\", \\\"azureml-dataset-runtime[fuse,pandas]\\\", \\\"tensorflow==2.0.0\\\", \\\"horovod==0.18.1\\\"]}, \\\"keras\\\", \\\"matplotlib\\\", \\\"scikit-learn\\\"], \\\"channels\\\": [\\\"anaconda\\\", \\\"conda-forge\\\"]}}, \\\"docker\\\": {\\\"enabled\\\": true, \\\"baseImage\\\": \\\"mcr.microsoft.com/azureml/openmpi3.1.2-ubuntu18.04:20200423.v1\\\", \\\"baseDockerfile\\\": null, \\\"sharedVolumes\\\": true, \\\"shmSize\\\": \\\"2g\\\", \\\"arguments\\\": [], \\\"baseImageRegistry\\\": {\\\"address\\\": null, \\\"username\\\": null, \\\"password\\\": null, \\\"registryIdentity\\\": null}, \\\"platform\\\": {\\\"os\\\": \\\"Linux\\\", \\\"architecture\\\": \\\"amd64\\\"}}, \\\"spark\\\": {\\\"repositories\\\": [], \\\"packages\\\": [], \\\"precachePackages\\\": false}, \\\"databricks\\\": {\\\"mavenLibraries\\\": [], \\\"pypiLibraries\\\": [], \\\"rcranLibraries\\\": [], \\\"jarLibraries\\\": [], \\\"eggLibraries\\\": []}, \\\"r\\\": null, \\\"inferencingStackVersion\\\": null}, \\\"history\\\": {\\\"outputCollection\\\": true, \\\"snapshotProject\\\": true, \\\"directoriesToWatch\\\": [\\\"logs\\\"]}, \\\"spark\\\": {\\\"configuration\\\": {\\\"spark.app.name\\\": \\\"Azure ML Experiment\\\", \\\"spark.yarn.maxAppAttempts\\\": 1}}, \\\"hdi\\\": {\\\"yarnDeployMode\\\": \\\"cluster\\\"}, \\\"tensorflow\\\": {\\\"workerCount\\\": 1, \\\"parameterServerCount\\\": 1}, \\\"mpi\\\": {\\\"processCountPerNode\\\": 1}, \\\"paralleltask\\\": {\\\"maxRetriesPerWorker\\\": 0, \\\"workerCountPerNode\\\": 1, \\\"terminalExitCodes\\\": null}, \\\"dataReferences\\\": {}, \\\"data\\\": {}, \\\"outputData\\\": {}, \\\"sourceDirectoryDataStore\\\": null, \\\"amlcompute\\\": {\\\"vmSize\\\": null, \\\"vmPriority\\\": null, \\\"retainCluster\\\": false, \\\"name\\\": null, \\\"clusterMaxNodeCount\\\": 1}}, \\\"TargetDetails\\\": null, \\\"SnapshotId\\\": \\\"56b0cb1e-41fb-41c9-a954-6f50d534d1e5\\\", \\\"TelemetryValues\\\": {\\\"amlClientType\\\": \\\"azureml-sdk-train\\\", \\\"amlClientModule\\\": \\\"[Scrubbed]\\\", \\\"amlClientFunction\\\": \\\"[Scrubbed]\\\", \\\"tenantId\\\": \\\"53a2628b-019a-476a-96c2-6b7acc5973b8\\\", \\\"amlClientRequestId\\\": \\\"139a772a-64c3-4a30-810b-c33d6170b851\\\", \\\"amlClientSessionId\\\": \\\"d77821ef-aefe-4ff4-a37b-ae24c8d6c893\\\", \\\"subscriptionId\\\": \\\"03712800-fbe1-4639-81d1-4ebb18f06dfc\\\", \\\"estimator\\\": \\\"TensorFlow\\\", \\\"samplingMethod\\\": \\\"GRID\\\", \\\"terminationPolicy\\\": \\\"MedianStopping\\\", \\\"primaryMetricGoal\\\": \\\"maximize\\\", \\\"maxTotalRuns\\\": 4, \\\"maxConcurrentRuns\\\": 2, \\\"maxDurationMinutes\\\": 10080, \\\"vmSize\\\": null}}}\", \"_aml_system_resume_child_runs\": \"null\", \"resume_child_runs\": \"null\", \"_aml_system_all_jobs_generated\": \"true\", \"all_jobs_generated\": \"true\", \"_aml_system_cancellation_requested\": \"true\", \"cancellation_requested\": \"true\", \"_aml_system_progress_metadata_evaluation_timestamp\": \"\\\"2020-08-31T09:20:16.017884\\\"\", \"progress_metadata_evaluation_timestamp\": \"\\\"2020-08-31T09:20:16.017884\\\"\", \"_aml_system_progress_metadata_digest\": \"\\\"80c7284bc36e0a6eedf09eaaac1907202e480c72cecaa4a4b4da7db95dfbe3bd\\\"\", \"progress_metadata_digest\": \"\\\"80c7284bc36e0a6eedf09eaaac1907202e480c72cecaa4a4b4da7db95dfbe3bd\\\"\", \"_aml_system_progress_metadata_active_timestamp\": \"\\\"2020-08-31T09:20:16.017884\\\"\", \"progress_metadata_active_timestamp\": \"\\\"2020-08-31T09:20:16.017884\\\"\", \"_aml_system_HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0\": \"{\\\"--epochs\\\": 15, \\\"--batch_size\\\": 16, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0\": \"{\\\"--epochs\\\": 15, \\\"--batch_size\\\": 16, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"_aml_system_HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1\": \"{\\\"--epochs\\\": 20, \\\"--batch_size\\\": 16, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1\": \"{\\\"--epochs\\\": 20, \\\"--batch_size\\\": 16, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"_aml_system_environment_preparation_status\": \"PREPARED\", \"environment_preparation_status\": \"PREPARED\", \"_aml_system_prepare_run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_preparation\", \"prepare_run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_preparation\", \"_aml_system_HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2\": \"{\\\"--epochs\\\": 15, \\\"--batch_size\\\": 32, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2\": \"{\\\"--epochs\\\": 15, \\\"--batch_size\\\": 32, \\\"--n_1layer\\\": 256, \\\"--n_2layer\\\": 123, \\\"--learning-rate\\\": 0.0001}\", \"_aml_system_HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0_cancelled\": \"true\", \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0_cancelled\": \"true\", \"_aml_system_HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2_cancelled\": \"true\", \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2_cancelled\": \"true\"}, \"end_time_utc\": \"2020-08-31T09:38:59.215393Z\", \"status\": \"Canceled\", \"log_files\": {\"azureml-logs/hyperdrive.txt\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e/azureml-logs/hyperdrive.txt?sv=2019-02-02&sr=b&sig=65brxLspDwUJQb4aegkbLpOGDUINtVpy1A1PVocQysA%3D&st=2020-08-31T13%3A30%3A33Z&se=2020-08-31T21%3A40%3A33Z&sp=r\"}, \"log_groups\": [[\"azureml-logs/hyperdrive.txt\"]], \"run_duration\": \"0:18:43\", \"hyper_parameters\": {\"--epochs\": [\"choice\", [[15, 20]]], \"--batch_size\": [\"choice\", [[16, 32]]], \"--n_1layer\": [\"choice\", [[256, 123]]], \"--n_2layer\": [\"choice\", [[123, 60]]], \"--learning-rate\": [\"choice\", [[0.0001, 0.001]]]}}, \"child_runs\": [{\"run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0\", \"run_number\": 219, \"metric\": null, \"status\": \"Canceled\", \"run_type\": \"azureml.scriptrun\", \"training_percent\": null, \"start_time\": \"2020-08-31T09:21:02.172736Z\", \"end_time\": \"2020-08-31T09:38:45.826799Z\", \"created_time\": \"2020-08-31T09:20:47.917001Z\", \"created_time_dt\": \"2020-08-31T09:20:47.917001Z\", \"duration\": \"0:17:57\", \"hyperdrive_id\": \"25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e\", \"arguments\": null, \"param_--epochs\": 15, \"param_--batch_size\": 16, \"param_--n_1layer\": 256, \"param_--n_2layer\": 123, \"param_--learning-rate\": 0.0001}, {\"run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1\", \"run_number\": 220, \"metric\": null, \"status\": \"Failed\", \"run_type\": \"azureml.scriptrun\", \"training_percent\": null, \"start_time\": \"2020-08-31T09:21:01.901537Z\", \"end_time\": \"2020-08-31T09:34:45.788148Z\", \"created_time\": \"2020-08-31T09:20:48.230176Z\", \"created_time_dt\": \"2020-08-31T09:20:48.230176Z\", \"duration\": \"0:13:57\", \"hyperdrive_id\": \"25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e\", \"arguments\": null, \"param_--epochs\": 20, \"param_--batch_size\": 16, \"param_--n_1layer\": 256, \"param_--n_2layer\": 123, \"param_--learning-rate\": 0.0001}, {\"run_id\": \"HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2\", \"run_number\": 221, \"metric\": null, \"status\": \"Canceled\", \"run_type\": \"azureml.scriptrun\", \"training_percent\": null, \"start_time\": \"2020-08-31T09:35:13.226604Z\", \"end_time\": \"2020-08-31T09:38:46.350548Z\", \"created_time\": \"2020-08-31T09:35:01.952901Z\", \"created_time_dt\": \"2020-08-31T09:35:01.952901Z\", \"duration\": \"0:03:44\", \"hyperdrive_id\": \"25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e\", \"arguments\": null, \"param_--epochs\": 15, \"param_--batch_size\": 32, \"param_--n_1layer\": 256, \"param_--n_2layer\": 123, \"param_--learning-rate\": 0.0001}], \"children_metrics\": {\"categories\": null, \"series\": null, \"metricName\": null}, \"run_metrics\": [], \"run_logs\": \"[2020-08-31T09:20:15.569728][API][INFO]Experiment created\\r\\n[2020-08-31T09:20:16.363580][GENERATOR][INFO]Trying to sample '2' jobs from the hyperparameter space\\r\\n[2020-08-31T09:20:16.6422651Z][SCHEDULER][INFO]The execution environment is being prepared. Please be patient as it can take a few minutes.\\r\\n[2020-08-31T09:20:16.627835][GENERATOR][INFO]Successfully sampled '2' jobs, they will soon be submitted to the execution target.\\r\\n[2020-08-31T09:20:47.3564092Z][SCHEDULER][INFO]Scheduling job, id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0'\\r\\n[2020-08-31T09:20:47.4390321Z][SCHEDULER][INFO]The execution environment was successfully prepared.\\r\\n[2020-08-31T09:20:47.3344909Z][SCHEDULER][INFO]Scheduling job, id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1'\\r\\n[2020-08-31T09:20:48.0731583Z][SCHEDULER][INFO]Successfully scheduled a job. Id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0'\\r\\n[2020-08-31T09:20:48.3617338Z][SCHEDULER][INFO]Successfully scheduled a job. Id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1'\\r\\n[2020-08-31T09:21:16.334407][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:21:48.761156][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:22:18.801365][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:22:48.657600][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:23:18.810485][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:23:49.174297][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:24:19.136014][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:24:48.966435][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:25:18.689551][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:25:49.096983][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:26:19.417981][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:26:49.860128][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:27:20.407633][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:27:51.340601][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:28:21.810137][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:28:54.355734][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:29:25.247756][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:29:56.305758][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:30:27.035213][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:30:57.381090][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:31:28.475216][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:32:00.991443][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:32:31.001363][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:33:00.951455][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:33:30.704203][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:34:00.755688][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:34:31.050096][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:34:59.227433][GENERATOR][INFO]Trying to sample '1' jobs from the hyperparameter space\\r\\n[2020-08-31T09:34:59.491531][GENERATOR][INFO]Successfully sampled '1' jobs, they will soon be submitted to the execution target.\\r\\n[2020-08-31T09:35:00.9206491Z][SCHEDULER][INFO]Scheduling job, id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2'\\r\\n[2020-08-31T09:35:01.477121][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:35:02.1152674Z][SCHEDULER][INFO]Successfully scheduled a job. Id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2'\\r\\n[2020-08-31T09:35:32.065661][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:36:01.990985][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:36:31.737197][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:37:02.334361][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:37:32.949968][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:38:03.289645][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:38:24.586052][API][INFO]Processing cancellation request by the user.\\r\\n[2020-08-31T09:38:24.716693][API][INFO]Experiment has been marked as canceled by the user, all active/pending jobs will soon be terminated/canceled.\\r\\n[2020-08-31T09:38:33.895031][ENFORCER][INFO]Jobs [https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0, https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2] do not contain any metrics with the primary metric name at this moment, policy cannot be applied.\\r\\n[2020-08-31T09:38:36.0458480Z][SCHEDULER][INFO]Cancelling job, id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2'\\r\\n[2020-08-31T09:38:36.0794099Z][SCHEDULER][INFO]Cancelling job, id='HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0'\\r\\n[2020-08-31T09:38:36.4018496Z][SCHEDULER][INFO]Updating job statuses to cancelled: [(job id = 'HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_0', previous status = 'RUNNING'), (job id = 'HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_2', previous status = 'RUNNING')]\\r\\n[2020-08-31T09:38:58.961383][CONTROLLER][WARNING]User errors were found in at least one of the child runs.\\r\\n[2020-08-31T09:38:59.507644][CONTROLLER][INFO]Experiment was 'ExperimentStatus.CANCEL_REQUESTED', is 'ExperimentStatus.CANCELLED'.\\n\\nError occurred: User errors were found in at least one of the child runs.\\n\", \"graph\": {}, \"widget_settings\": {\"childWidgetDisplay\": \"popup\", \"send_telemetry\": false, \"log_level\": \"INFO\", \"sdk_version\": \"1.12.0\"}, \"loading\": false}"
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/plain": [
       "{'runId': 'HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e',\n",
       " 'target': 'ci-eva3',\n",
       " 'status': 'Canceled',\n",
       " 'startTimeUtc': '2020-08-31T09:20:15.269383Z',\n",
       " 'endTimeUtc': '2020-08-31T09:38:59.215393Z',\n",
       " 'error': {'error': {'code': 'UserError',\n",
       "   'message': 'User errors were found in at least one of the child runs.',\n",
       "   'details': [],\n",
       "   'debugInfo': {'message': '[(https://westeurope.experiments.azureml.net/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/**SCRUBBED**/runs/HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e_1, {\\'error\\': {\\n    \"additional_properties\": {\\n        \"componentName\": \"execution-worker\"\\n    },\\n    \"error\": {\\n        \"additional_properties\": {\\n            \"messageParameters\": null,\\n            \"referenceCode\": null,\\n            \"messageFormat\": null,\\n            \"severity\": null\\n        },\\n        \"code\": \"UserError\",\\n        \"message\": \"AzureMLCompute job failed.\\\\nJobFailed: Submitted script failed with a non-zero exit code; see the driver log file for details.\",\\n        \"details_uri\": null,\\n        \"target\": null,\\n        \"details\": [],\\n        \"inner_error\": null,\\n        \"debug_info\": null\\n    },\\n    \"correlation\": {\\n        \"operation\": null,\\n        \"request\": \"cf951ff516eb5b6c\"\\n    },\\n    \"environment\": \"westeurope\",\\n    \"location\": \"westeurope\",\\n    \"time\": {}\\n}})]'},\n",
       "   'messageParameters': {}},\n",
       "  'time': '0001-01-01T00:00:00.000Z'},\n",
       " 'properties': {'primary_metric_config': '{\"name\": \"Accuracy\", \"goal\": \"maximize\"}',\n",
       "  'resume_from': 'null',\n",
       "  'runTemplate': 'HyperDrive',\n",
       "  'azureml.runsource': 'hyperdrive',\n",
       "  'platform': 'AML',\n",
       "  'ContentSnapshotId': '56b0cb1e-41fb-41c9-a954-6f50d534d1e5'},\n",
       " 'inputDatasets': [],\n",
       " 'outputDatasets': [],\n",
       " 'logFiles': {'azureml-logs/hyperdrive.txt': 'https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.HD_25fcd4ea-2f1c-4aea-960b-d3d9f6c15c3e/azureml-logs/hyperdrive.txt?sv=2019-02-02&sr=b&sig=duP7USK1993ufiyJmwA3mNrGZgjWMaP0pgAvt%2BWyNyU%3D&st=2020-08-31T09%3A29%3A02Z&se=2020-08-31T17%3A39%3A02Z&sp=r'}}"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from azureml.core import Experiment\n",
    "from azureml.train.sklearn import SKLearn\n",
    "from azureml.train.estimator import Estimator\n",
    "from azureml.train.dnn import TensorFlow\n",
    "from azureml.train.hyperdrive import GridParameterSampling, BanditPolicy, HyperDriveConfig, PrimaryMetricGoal, choice, normal\n",
    "from azureml.train.hyperdrive import uniform, choice\n",
    "from azureml.widgets import RunDetails\n",
    "from azureml.train.hyperdrive import MedianStoppingPolicy\n",
    "\n",
    "\n",
    "# Sample a range of parameter values\n",
    "params = GridParameterSampling(\n",
    "    {\n",
    "        '--epochs': choice(15,20),   \n",
    "        '--batch_size': choice(16,32),        \n",
    "        '--n_1layer': choice(256,123),        \n",
    "        '--n_2layer': choice(123,60),\n",
    "        '--learning-rate': choice(0.0001,0.001)\n",
    "                                 \n",
    "        \n",
    "    }\n",
    ")\n",
    "\n",
    "\n",
    "hyper_estimator = TensorFlow(source_directory=training_folder,                                            \n",
    "                      entry_script='covid_training_dense169.py',                                            \n",
    "                      compute_target=compute_cluster,\n",
    "                      conda_packages=['keras','matplotlib','scikit-learn'],                      \n",
    "                      framework_version='2.0'                                \n",
    "                      )\n",
    "early_termination_policy = MedianStoppingPolicy()\n",
    "# Configure hyperdrive settings\n",
    "hyperdrive = HyperDriveConfig(estimator=hyper_estimator, \n",
    "                          hyperparameter_sampling=params,                           \n",
    "                          primary_metric_name='Accuracy', \n",
    "                          primary_metric_goal=PrimaryMetricGoal.MAXIMIZE, \n",
    "                          policy=early_termination_policy,    \n",
    "                          max_total_runs=4,\n",
    "                          max_concurrent_runs=2)\n",
    "\n",
    "# Run the experiment\n",
    "experiment = Experiment(workspace = ws, name = 'covid_hyperdrive')\n",
    "run = experiment.submit(config=hyperdrive)\n",
    "\n",
    "# Show the status in the notebook as the experiment runs\n",
    "RunDetails(run).show()\n",
    "run.wait_for_completion()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "%%writefile $training_folder/covid_training_ResNet50.py\n",
    "\n",
    "from azureml.core import Run\n",
    "from azureml.core import Workspace, Dataset\n",
    "import argparse\n",
    "from tensorflow.keras.preprocessing.image import ImageDataGenerator\n",
    "from tensorflow.keras.preprocessing.image import DirectoryIterator\n",
    "from tensorflow.keras.applications.densenet import DenseNet169\n",
    "from random import shuffle\n",
    "from tensorflow.keras import Model\n",
    "from tensorflow.keras.layers import Flatten, Dense\n",
    "from matplotlib import pyplot as plt\n",
    "import numpy as np\n",
    "import tensorflow as tf\n",
    "from sklearn.metrics import confusion_matrix,accuracy_score,roc_auc_score,classification_report\n",
    "from azureml.core import Workspace, Dataset\n",
    "import joblib\n",
    "\n",
    "# Get parameters\n",
    "parser = argparse.ArgumentParser()\n",
    "parser.add_argument('--epochs', type=int, dest='hp_epochs', default=10, help='epoch hyperparam')\n",
    "parser.add_argument('--batch_size', type=int, dest='hp_batch_size', default=15, help='batch-size hyperparam')\n",
    "parser.add_argument('--learning-rate', type=float, dest='hp_lr', default=0.001, help='learning rate hyperparam')\n",
    "parser.add_argument('--n_1layer', type=int, dest='n_1layer', default=512, help='1 layer neurons hyperparam')\n",
    "parser.add_argument('--n_2layer', type=int, dest='n_2layer', default=256, help='2 layer neurons hyperparam')\n",
    "\n",
    "args = parser.parse_args()\n",
    "hparam_epochs = args.hp_epochs\n",
    "hparam_batch_size = args.hp_batch_size\n",
    "hparam_lr = args.hp_lr\n",
    "hparam_1l = args.n_1layer\n",
    "hparam_2l = args.n_2layer\n",
    "\n",
    "run = Run.get_context()\n",
    "\n",
    "\n",
    "\n",
    "pretrained_size = (300,300)\n",
    "batch_size = hparam_batch_size\n",
    "\n",
    "\n",
    "print(\"Getting Data...\")\n",
    "datagen =ImageDataGenerator(\n",
    "      samplewise_center=True,\n",
    "      samplewise_std_normalization= True,\n",
    "      width_shift_range=0.2,\n",
    "      height_shift_range=0.2,\n",
    "      shear_range=0.2,\n",
    "      zoom_range=0.2,\n",
    "      fill_mode='nearest'\n",
    "                                  )\n",
    "\n",
    "print(\"Preparing training dataset...\")\n",
    "training_dataset = datagen.flow_from_directory(\n",
    "    '/mnt/batch/tasks/shared/LS_root/mounts/clusters/ci-eva3/code/users/eva/covid-img/train',\n",
    "    target_size=pretrained_size, # resize to match model expected input\n",
    "    batch_size=batch_size, \n",
    "    shuffle=shuffle) \n",
    "\n",
    "print(\"Preparing validation dataset...\")\n",
    "validation_dataset = datagen.flow_from_directory(\n",
    "    '/mnt/batch/tasks/shared/LS_root/mounts/clusters/ci-eva3/code/users/eva/covid-img/test',\n",
    "    target_size=pretrained_size, # resize to match model expected input\n",
    "    batch_size=batch_size, \n",
    "    shuffle=shuffle)\n",
    "    \n",
    "classnames = list(training_dataset.class_indices.keys())\n",
    "print(\"class names\", classnames)\n",
    "\n",
    "#load weight\n",
    "\n",
    "\n",
    "#Load the base model, not including its final connected layer, and set the input shape to match our images\n",
    "base_model = ResNet50(weights='imagenet', include_top=False, input_shape=training_dataset.image_shape)\n",
    "\n",
    "\n",
    "# Freeze the already-trained layers in the base model\n",
    "for layer in base_model.layers:\n",
    "    layer.trainable = False\n",
    "\n",
    "# Create layers for classification of our images\n",
    "x = base_model.output\n",
    "x = Flatten()(x)\n",
    "\n",
    "#add 2 more dense layers\n",
    "#Full Connected Layers\n",
    "x = Dense(hparam_1l, activation='relu')(x)\n",
    "x = tf.keras.layers.Dropout(0.2)(x)\n",
    "x = Dense(hparam_2l, activation='relu')(x)\n",
    "\n",
    "\n",
    "#Full Connected Layers\n",
    "x = tf.keras.layers.Dense(hparam_1l, activation='relu')(x)\n",
    "#Add dropout to avoid Overfit\n",
    "x = tf.keras.layers.Dropout(0.2)(x)\n",
    "x = tf.keras.layers.Dense(hparam_2l, activation='relu')(x)\n",
    "x = tf.keras.layers.Dense(128, activation='relu')(x)\n",
    "#Add dropout to avoid Overfit\n",
    "x = tf.keras.layers.Dropout(0.4)(x)\n",
    "x = tf.keras.layers.Dense(64, activation='relu')(x)\n",
    "\n",
    "x = Dense(len(classnames), activation='softmax')(x) \n",
    "model = Model(inputs=base_model.input, outputs=x)\n",
    "\n",
    "\n",
    "hp_optimizer = tf.keras.optimizers.Adam(learning_rate=hparam_lr)\n",
    "\n",
    "# Compile the model\n",
    "model.compile(loss='categorical_crossentropy',\n",
    "              optimizer='Adam',\n",
    "              metrics=['accuracy'])\n",
    "\n",
    "# Now print the full model, which will include the layers of the base model plus the dense layer we added\n",
    "\n",
    "run.log_row(\"model\",model.summary())\n",
    "\n",
    "# Train the model over hparam_epochs\n",
    "\n",
    "history = model.fit(\n",
    "    training_dataset,\n",
    "    steps_per_epoch = training_dataset.samples // batch_size,\n",
    "    validation_data = validation_dataset, \n",
    "    validation_steps = validation_dataset.samples // batch_size,\n",
    "    epochs = hparam_epochs)\n",
    "\n",
    "#print accuracy and loss plot\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "plt.plot(history.history['accuracy'])\n",
    "plt.title('model accuracy')\n",
    "plt.ylabel('accuracy')\n",
    "plt.xlabel('epoch')\n",
    "plt.legend(['train'], loc='upper left')\n",
    "plt.show()\n",
    "run.log_image(\"accuracy\",plot=plt)\n",
    "# summarize history for loss\n",
    "plt.plot(history.history['loss'])\n",
    "plt.title('model loss')\n",
    "plt.ylabel('loss')\n",
    "plt.xlabel('epoch')\n",
    "plt.legend(['train'], loc='upper left')\n",
    "plt.show()\n",
    "run.log_image(\"loss\",plot=plt)\n",
    "\n",
    "print(model.evaluate())\n",
    "\n",
    "# Use the moedl to predict the class\n",
    "Y_pred = model.predict_generator(validation_dataset)\n",
    "\n",
    "# The model returns a probability value for each class\n",
    "# The one with the highest probability is the predicted class\n",
    "y_pred = np.argmax(Y_pred, axis=1)\n",
    "\n",
    "# Plot the confusion matrix\n",
    "cm=confusion_matrix(validation_dataset.classes, y_pred)\n",
    "print(cm)\n",
    "plt.imshow(cm, interpolation=\"nearest\", cmap=plt.cm.Blues)\n",
    "plt.colorbar()\n",
    "tick_marks = np.arange(len(classnames))\n",
    "plt.xticks(tick_marks, classnames, rotation=85)\n",
    "plt.yticks(tick_marks, classnames)\n",
    "plt.xlabel(\"Predicted Shape\")\n",
    "plt.ylabel(\"True Shape\")\n",
    "plt.show()\n",
    "run.log_image('Confusion Matrix', plot=plt)\n",
    "\n",
    "print('Classification Report')\n",
    "target_names = validation_dataset.classes\n",
    "class_labels = list(validation_dataset.class_indices.keys())   \n",
    "report = classification_report(target_names, y_pred, target_names=class_labels)\n",
    "print(report) \n",
    "\n",
    "run.complete()\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Overwriting covid-training2/covid_training_dense169.py\n"
     ]
    }
   ],
   "source": [
    "%%writefile $training_folder/covid_training_dense169.py\n",
    "\n",
    "from azureml.core import Run\n",
    "from azureml.core import Workspace, Dataset\n",
    "import argparse\n",
    "from tensorflow.keras.preprocessing.image import ImageDataGenerator\n",
    "from tensorflow.keras.preprocessing.image import DirectoryIterator\n",
    "from tensorflow.keras.applications.densenet import DenseNet169\n",
    "from random import shuffle\n",
    "from tensorflow.keras import Model\n",
    "from tensorflow.keras.layers import Flatten, Dense\n",
    "from matplotlib import pyplot as plt\n",
    "import numpy as np\n",
    "import tensorflow as tf\n",
    "from sklearn.metrics import confusion_matrix,accuracy_score,roc_auc_score,classification_report\n",
    "from azureml.core import Workspace, Dataset\n",
    "import joblib\n",
    "\n",
    "# Get parameters\n",
    "parser = argparse.ArgumentParser()\n",
    "parser.add_argument('--epochs', type=int, dest='hp_epochs', default=10, help='epoch hyperparam')\n",
    "parser.add_argument('--batch_size', type=int, dest='hp_batch_size', default=15, help='batch-size hyperparam')\n",
    "parser.add_argument('--learning-rate', type=float, dest='hp_lr', default=0.001, help='learning rate hyperparam')\n",
    "parser.add_argument('--n_1layer', type=int, dest='n_1layer', default=512, help='1 layer neurons hyperparam')\n",
    "parser.add_argument('--n_2layer', type=int, dest='n_2layer', default=256, help='2 layer neurons hyperparam')\n",
    "\n",
    "args = parser.parse_args()\n",
    "hparam_epochs = args.hp_epochs\n",
    "hparam_batch_size = args.hp_batch_size\n",
    "hparam_lr = args.hp_lr\n",
    "hparam_1l = args.n_1layer\n",
    "hparam_2l = args.n_2layer\n",
    "\n",
    "run = Run.get_context()\n",
    "\n",
    "\n",
    "\n",
    "pretrained_size = (300,300)\n",
    "batch_size = hparam_batch_size\n",
    "\n",
    "\n",
    "print(\"Getting Data...\")\n",
    "datagen =ImageDataGenerator(\n",
    "      samplewise_center=True,\n",
    "      samplewise_std_normalization= True,\n",
    "      width_shift_range=0.2,\n",
    "      height_shift_range=0.2,\n",
    "      shear_range=0.2,\n",
    "      zoom_range=0.2,\n",
    "      fill_mode='nearest'\n",
    "                                  )\n",
    "\n",
    "print(\"Preparing training dataset...\")\n",
    "training_dataset = datagen.flow_from_directory(\n",
    "    '/mnt/batch/tasks/shared/LS_root/mounts/clusters/ci-eva3/code/users/eva/covid-img/train',\n",
    "    target_size=pretrained_size, # resize to match model expected input\n",
    "    batch_size=batch_size, \n",
    "    shuffle=shuffle) \n",
    "\n",
    "print(\"Preparing validation dataset...\")\n",
    "validation_dataset = datagen.flow_from_directory(\n",
    "    '/mnt/batch/tasks/shared/LS_root/mounts/clusters/ci-eva3/code/users/eva/covid-img/test',\n",
    "    target_size=pretrained_size, # resize to match model expected input\n",
    "    batch_size=batch_size, \n",
    "    shuffle=shuffle)\n",
    "    \n",
    "classnames = list(training_dataset.class_indices.keys())\n",
    "print(\"class names\", classnames)\n",
    "\n",
    "#load weight\n",
    "\n",
    "\n",
    "#Load the base model, not including its final connected layer, and set the input shape to match our images\n",
    "base_model = DenseNet169(weights=None, include_top=False, input_shape=training_dataset.image_shape)\n",
    "\n",
    "# Freeze the already-trained layers in the base model\n",
    "for layer in base_model.layers:\n",
    "    layer.trainable = False\n",
    "\n",
    "# Create layers for classification of our images\n",
    "x = base_model.output\n",
    "x = Flatten()(x)\n",
    "\n",
    "#add 2 more dense layers\n",
    "#Full Connected Layers\n",
    "x = Dense(hparam_1l, activation='relu')(x)\n",
    "x = tf.keras.layers.Dropout(0.2)(x)\n",
    "x = Dense(hparam_2l, activation='relu')(x)\n",
    "\n",
    "\n",
    "#Full Connected Layers\n",
    "x = tf.keras.layers.Dense(hparam_1l, activation='relu')(x)\n",
    "#Add dropout to avoid Overfit\n",
    "x = tf.keras.layers.Dropout(0.2)(x)\n",
    "x = tf.keras.layers.Dense(hparam_2l, activation='relu')(x)\n",
    "x = tf.keras.layers.Dense(128, activation='relu')(x)\n",
    "#Add dropout to avoid Overfit\n",
    "x = tf.keras.layers.Dropout(0.4)(x)\n",
    "x = tf.keras.layers.Dense(64, activation='relu')(x)\n",
    "\n",
    "x = Dense(len(classnames), activation='softmax')(x) \n",
    "model = Model(inputs=base_model.input, outputs=x)\n",
    "\n",
    "\n",
    "hp_optimizer = tf.keras.optimizers.Adam(learning_rate=hparam_lr)\n",
    "\n",
    "# Compile the model\n",
    "model.compile(loss='categorical_crossentropy',\n",
    "              optimizer='Adam',\n",
    "              metrics=['accuracy'])\n",
    "\n",
    "# Now print the full model, which will include the layers of the base model plus the dense layer we added\n",
    "\n",
    "run.log_row(\"model\",model.summary())\n",
    "\n",
    "# Train the model over hparam_epochs\n",
    "\n",
    "history = model.fit(\n",
    "    training_dataset,\n",
    "    steps_per_epoch = training_dataset.samples // batch_size,\n",
    "    validation_data = validation_dataset, \n",
    "    validation_steps = validation_dataset.samples // batch_size,\n",
    "    epochs = hparam_epochs)\n",
    "\n",
    "#print accuracy and loss plot\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "plt.plot(history.history['accuracy'])\n",
    "plt.title('model accuracy')\n",
    "plt.ylabel('accuracy')\n",
    "plt.xlabel('epoch')\n",
    "plt.legend(['train'], loc='upper left')\n",
    "plt.show()\n",
    "run.log_image(\"accuracy\",plot=plt)\n",
    "# summarize history for loss\n",
    "plt.plot(history.history['loss'])\n",
    "plt.title('model loss')\n",
    "plt.ylabel('loss')\n",
    "plt.xlabel('epoch')\n",
    "plt.legend(['train'], loc='upper left')\n",
    "plt.show()\n",
    "run.log_image(\"loss\",plot=plt)\n",
    "\n",
    "print(model.evaluate())\n",
    "\n",
    "# Use the moedl to predict the class\n",
    "Y_pred = model.predict_generator(validation_dataset)\n",
    "\n",
    "# The model returns a probability value for each class\n",
    "# The one with the highest probability is the predicted class\n",
    "y_pred = np.argmax(Y_pred, axis=1)\n",
    "\n",
    "# Plot the confusion matrix\n",
    "cm=confusion_matrix(validation_dataset.classes, y_pred)\n",
    "print(cm)\n",
    "plt.imshow(cm, interpolation=\"nearest\", cmap=plt.cm.Blues)\n",
    "plt.colorbar()\n",
    "tick_marks = np.arange(len(classnames))\n",
    "plt.xticks(tick_marks, classnames, rotation=85)\n",
    "plt.yticks(tick_marks, classnames)\n",
    "plt.xlabel(\"Predicted Shape\")\n",
    "plt.ylabel(\"True Shape\")\n",
    "plt.show()\n",
    "run.log_image('Confusion Matrix', plot=plt)\n",
    "\n",
    "print('Classification Report')\n",
    "target_names = validation_dataset.classes\n",
    "class_labels = list(validation_dataset.class_indices.keys())   \n",
    "report = classification_report(target_names, y_pred, target_names=class_labels)\n",
    "print(report) \n",
    "\n",
    "run.complete()\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "de66b0aa6a384b3881c6d0b57d237182",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "_UserRunWidget(widget_settings={'childWidgetDisplay': 'popup', 'send_telemetry': False, 'log_level': 'INFO', 'â€¦"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/aml.mini.widget.v1": "{\"status\": \"Running\", \"workbench_run_details_uri\": \"https://ml.azure.com/experiments/covid-training2/runs/covid-training2_1598883241_77ea4914?wsid=/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourcegroups/RG-eva/workspaces/ws-eva\", \"run_id\": \"covid-training2_1598883241_77ea4914\", \"run_properties\": {\"run_id\": \"covid-training2_1598883241_77ea4914\", \"created_utc\": \"2020-08-31T14:14:03.360387Z\", \"properties\": {\"_azureml.ComputeTargetType\": \"amlcompute\", \"ContentSnapshotId\": \"83082e4e-0700-463a-b897-a1ca42f60b5a\", \"ProcessInfoFile\": \"azureml-logs/process_info.json\", \"ProcessStatusFile\": \"azureml-logs/process_status.json\"}, \"tags\": {\"_aml_system_ComputeTargetStatus\": \"{\\\"AllocationState\\\":\\\"steady\\\",\\\"PreparingNodeCount\\\":0,\\\"RunningNodeCount\\\":0,\\\"CurrentNodeCount\\\":1}\"}, \"script_name\": null, \"arguments\": null, \"end_time_utc\": null, \"status\": \"Running\", \"log_files\": {\"azureml-logs/55_azureml-execution-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/azureml-logs/55_azureml-execution-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt?sv=2019-02-02&sr=b&sig=OHA5G6rCS2RZCrK3fHUyzOiHEld%2BK14JmKP7lLWwknY%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"azureml-logs/65_job_prep-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/azureml-logs/65_job_prep-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt?sv=2019-02-02&sr=b&sig=tMC5D9Ft%2BXwfuZ9ELuqm%2FDQy36gLyVNOyR1eCMKUC08%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"azureml-logs/70_driver_log.txt\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/azureml-logs/70_driver_log.txt?sv=2019-02-02&sr=b&sig=7WyIS3OgHTCcypEI%2BNoscT%2F%2BdsoSsprhKrdEXGvHajw%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"azureml-logs/process_info.json\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/azureml-logs/process_info.json?sv=2019-02-02&sr=b&sig=cDl2UKBQ78pQpASQnv64yQHXoye4MOgGZ%2BTrXIg5FMc%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"azureml-logs/process_status.json\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/azureml-logs/process_status.json?sv=2019-02-02&sr=b&sig=IdJo%2FeatIxkTRC70s8RsHSESnMKx1%2Be3V1Kob28qEHI%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"logs/azureml/92_azureml.log\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/logs/azureml/92_azureml.log?sv=2019-02-02&sr=b&sig=yTlRbBb7tHzB7H612iJ1kPGKcqY4ROfjlmajhShJqPc%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\", \"logs/azureml/job_prep_azureml.log\": \"https://wseva1634245866.blob.core.windows.net/azureml/ExperimentRun/dcid.covid-training2_1598883241_77ea4914/logs/azureml/job_prep_azureml.log?sv=2019-02-02&sr=b&sig=%2BenM2ZCLz9n8G4k7DQ4NBAxXAz%2BGYqZyAsL4s3TEWRE%3D&st=2020-08-31T14%3A05%3A51Z&se=2020-08-31T22%3A15%3A51Z&sp=r\"}, \"log_groups\": [[\"azureml-logs/process_info.json\", \"azureml-logs/process_status.json\", \"logs/azureml/job_prep_azureml.log\"], [\"azureml-logs/55_azureml-execution-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt\"], [\"azureml-logs/65_job_prep-tvmps_31bb17118f06f5de2ac94420733f828d1be3ee9f97c2d8f2fe15655a641ed6ca_d.txt\"], [\"azureml-logs/70_driver_log.txt\"], [\"logs/azureml/92_azureml.log\"]], \"run_duration\": \"0:09:19\"}, \"child_runs\": [], \"children_metrics\": {}, \"run_metrics\": [], \"run_logs\": \"2020-08-31 14:15:30,852|azureml|DEBUG|Inputs:: kwargs: {'OutputCollection': True, 'EnableMLflowTracking': True, 'snapshotProject': True, 'only_in_process_features': True, 'skip_track_logs_dir': True}, track_folders: None, deny_list: None, directories_to_watch: []\\n2020-08-31 14:15:30,853|azureml.history._tracking.PythonWorkingDirectory|DEBUG|Execution target type: batchai\\n2020-08-31 14:15:30,861|azureml.history._tracking.PythonWorkingDirectory|DEBUG|Failed to import pyspark with error: No module named 'pyspark'\\n2020-08-31 14:15:30,861|azureml.history._tracking.PythonWorkingDirectory.workingdir|DEBUG|Pinning working directory for filesystems: ['pyfs']\\n2020-08-31 14:15:31,113|azureml.core.run|DEBUG|Adding new factory <function ScriptRun._from_run_dto at 0x7fa86a2b8c80> for run source azureml.scriptrun\\n2020-08-31 14:15:31,141|azureml.core.authentication.TokenRefresherDaemon|DEBUG|Starting daemon and triggering first instance\\n2020-08-31 14:15:31,147|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,147|azureml._restclient.clientbase|INFO|Created a worker pool for first use\\n2020-08-31 14:15:31,148|azureml.core.authentication|DEBUG|Time to expire 1814311.851984 seconds\\n2020-08-31 14:15:31,148|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,148|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,148|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,148|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,193|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,193|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,194|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:31,198|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,206|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,211|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,216|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,221|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:31,222|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.RunClient.get-async:False|DEBUG|[START]\\n2020-08-31 14:15:31,222|msrest.service_client|DEBUG|Accept header absent and forced to application/json\\n2020-08-31 14:15:31,222|msrest.http_logger|DEBUG|Request URL: 'https://westeurope.experiments.azureml.net/history/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runs/covid-training2_1598883241_77ea4914'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|Request method: 'GET'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|Request headers:\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|    'Accept': 'application/json'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|    'Content-Type': 'application/json; charset=utf-8'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '53c3247d-565e-405d-97d6-cec44304185c'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|    'request-id': '53c3247d-565e-405d-97d6-cec44304185c'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|    'User-Agent': 'python/3.6.2 (Linux-4.15.0-1092-azure-x86_64-with-debian-buster-sid) msrest/0.6.18 azureml._restclient/core.1.12.0 azureml-sdk-core/1.12.0'\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|Request body:\\n2020-08-31 14:15:31,223|msrest.http_logger|DEBUG|None\\n2020-08-31 14:15:31,223|msrest.universal_http|DEBUG|Configuring redirects: allow=True, max=30\\n2020-08-31 14:15:31,223|msrest.universal_http|DEBUG|Configuring request: timeout=100, verify=True, cert=None\\n2020-08-31 14:15:31,224|msrest.universal_http|DEBUG|Configuring proxies: ''\\n2020-08-31 14:15:31,224|msrest.universal_http|DEBUG|Evaluate proxies against ENV settings: True\\n2020-08-31 14:15:31,302|msrest.http_logger|DEBUG|Response status: 200\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|Response headers:\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Date': 'Mon, 31 Aug 2020 14:15:31 GMT'\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Content-Type': 'application/json; charset=utf-8'\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Transfer-Encoding': 'chunked'\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Connection': 'keep-alive'\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Vary': 'Accept-Encoding'\\n2020-08-31 14:15:31,303|msrest.http_logger|DEBUG|    'Request-Context': 'appId=cid-v1:6a27ce65-5555-41a3-85f7-b7a1ce31fd6b'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'x-ms-response-type': 'standard'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '53c3247d-565e-405d-97d6-cec44304185c'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'x-ms-client-session-id': ''\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'x-request-time': '0.063'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'Strict-Transport-Security': 'max-age=15724800; includeSubDomains; preload'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'X-Content-Type-Options': 'nosniff'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|    'Content-Encoding': 'gzip'\\n2020-08-31 14:15:31,304|msrest.http_logger|DEBUG|Response content:\\n2020-08-31 14:15:31,305|msrest.http_logger|DEBUG|{\\n  \\\"runNumber\\\": 2,\\n  \\\"rootRunId\\\": \\\"covid-training2_1598883241_77ea4914\\\",\\n  \\\"experimentId\\\": \\\"a4d0b257-40d8-42cc-85d0-b46f739c7b9f\\\",\\n  \\\"createdUtc\\\": \\\"2020-08-31T14:14:03.3603877+00:00\\\",\\n  \\\"createdBy\\\": {\\n    \\\"userObjectId\\\": \\\"dd31caf9-cba0-45cd-9562-950e2d57ea24\\\",\\n    \\\"userPuId\\\": \\\"10032000CF0AD7A6\\\",\\n    \\\"userIdp\\\": \\\"live.com\\\",\\n    \\\"userAltSecId\\\": \\\"1:live.com:00037FFE1E1C4C5E\\\",\\n    \\\"userIss\\\": \\\"https://sts.windows.net/53a2628b-019a-476a-96c2-6b7acc5973b8/\\\",\\n    \\\"userTenantId\\\": \\\"53a2628b-019a-476a-96c2-6b7acc5973b8\\\",\\n    \\\"userName\\\": \\\"Oscar Jaldo Amigo\\\"\\n  },\\n  \\\"userId\\\": \\\"dd31caf9-cba0-45cd-9562-950e2d57ea24\\\",\\n  \\\"token\\\": null,\\n  \\\"tokenExpiryTimeUtc\\\": null,\\n  \\\"error\\\": null,\\n  \\\"warnings\\\": null,\\n  \\\"revision\\\": 8,\\n  \\\"runUuid\\\": \\\"16896f19-a985-421d-a2db-ad86db833fb7\\\",\\n  \\\"parentRunUuid\\\": null,\\n  \\\"rootRunUuid\\\": \\\"16896f19-a985-421d-a2db-ad86db833fb7\\\",\\n  \\\"runId\\\": \\\"covid-training2_1598883241_77ea4914\\\",\\n  \\\"parentRunId\\\": null,\\n  \\\"status\\\": \\\"Running\\\",\\n  \\\"startTimeUtc\\\": \\\"2020-08-31T14:15:12.5638985+00:00\\\",\\n  \\\"endTimeUtc\\\": null,\\n  \\\"options\\\": {\\n    \\\"generateDataContainerIdIfNotSpecified\\\": true\\n  },\\n  \\\"name\\\": null,\\n  \\\"dataContainerId\\\": \\\"dcid.covid-training2_1598883241_77ea4914\\\",\\n  \\\"description\\\": null,\\n  \\\"hidden\\\": false,\\n  \\\"runType\\\": \\\"azureml.scriptrun\\\",\\n  \\\"properties\\\": {\\n    \\\"_azureml.ComputeTargetType\\\": \\\"amlcompute\\\",\\n    \\\"ContentSnapshotId\\\": \\\"83082e4e-0700-463a-b897-a1ca42f60b5a\\\",\\n    \\\"ProcessInfoFile\\\": \\\"azureml-logs/process_info.json\\\",\\n    \\\"ProcessStatusFile\\\": \\\"azureml-logs/process_status.json\\\"\\n  },\\n  \\\"scriptName\\\": \\\"covid_training_dense169.py\\\",\\n  \\\"target\\\": \\\"ci-eva3\\\",\\n  \\\"uniqueChildRunComputeTargets\\\": [],\\n  \\\"tags\\\": {\\n    \\\"_aml_system_ComputeTargetStatus\\\": \\\"{\\\\\\\"AllocationState\\\\\\\":\\\\\\\"steady\\\\\\\",\\\\\\\"PreparingNodeCount\\\\\\\":0,\\\\\\\"RunningNodeCount\\\\\\\":0,\\\\\\\"CurrentNodeCount\\\\\\\":1}\\\"\\n  },\\n  \\\"inputDatasets\\\": [],\\n  \\\"outputDatasets\\\": [],\\n  \\\"runDefinition\\\": null,\\n  \\\"createdFrom\\\": {\\n    \\\"type\\\": \\\"Notebook\\\",\\n    \\\"locationType\\\": \\\"ArtifactId\\\",\\n    \\\"location\\\": \\\"LocalUpload/covid-training2_1598883241_77ea4914/covid19_dense.ipynb\\\"\\n  },\\n  \\\"cancelUri\\\": \\\"https://westeurope.experiments.azureml.net/execution/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runId/covid-training2_1598883241_77ea4914/cancel\\\",\\n  \\\"completeUri\\\": null,\\n  \\\"diagnosticsUri\\\": \\\"https://westeurope.experiments.azureml.net/execution/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runId/covid-training2_1598883241_77ea4914/diagnostics\\\",\\n  \\\"computeRequest\\\": {\\n    \\\"nodeCount\\\": 1\\n  },\\n  \\\"retainForLifetimeOfWorkspace\\\": false,\\n  \\\"queueingInfo\\\": null\\n}\\n2020-08-31 14:15:31,309|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.RunClient.get-async:False|DEBUG|[STOP]\\n2020-08-31 14:15:31,310|azureml._SubmittedRun#covid-training2_1598883241_77ea4914|DEBUG|Constructing run from dto. type: azureml.scriptrun, source: None, props: {'_azureml.ComputeTargetType': 'amlcompute', 'ContentSnapshotId': '83082e4e-0700-463a-b897-a1ca42f60b5a', 'ProcessInfoFile': 'azureml-logs/process_info.json', 'ProcessStatusFile': 'azureml-logs/process_status.json'}\\n2020-08-31 14:15:31,314|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunContextManager|DEBUG|Valid logs dir, setting up content loader\\n2020-08-31 14:15:31,314|azureml|WARNING|Could not import azureml.mlflow or azureml.contrib.mlflow mlflow APIs will not run against AzureML services.  Add azureml-mlflow as a conda dependency for the run if this behavior is desired\\n2020-08-31 14:15:31,314|azureml.WorkerPool|DEBUG|[START]\\n2020-08-31 14:15:31,314|azureml.SendRunKillSignal|DEBUG|[START]\\n2020-08-31 14:15:31,315|azureml.RunStatusContext|DEBUG|[START]\\n2020-08-31 14:15:31,315|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunContextManager.RunStatusContext|DEBUG|[START]\\n2020-08-31 14:15:31,315|azureml.WorkingDirectoryCM|DEBUG|[START]\\n2020-08-31 14:15:31,315|azureml.history._tracking.PythonWorkingDirectory.workingdir|DEBUG|[START]\\n2020-08-31 14:15:31,315|azureml.history._tracking.PythonWorkingDirectory|INFO|Current working dir: /mnt/batch/tasks/shared/LS_root/jobs/ws-eva/azureml/covid-training2_1598883241_77ea4914/mounts/workspaceblobstore/azureml/covid-training2_1598883241_77ea4914\\n2020-08-31 14:15:31,315|azureml.history._tracking.PythonWorkingDirectory.workingdir|DEBUG|Calling pyfs\\n2020-08-31 14:15:31,315|azureml.history._tracking.PythonWorkingDirectory.workingdir|DEBUG|Storing working dir for pyfs as /mnt/batch/tasks/shared/LS_root/jobs/ws-eva/azureml/covid-training2_1598883241_77ea4914/mounts/workspaceblobstore/azureml/covid-training2_1598883241_77ea4914\\n2020-08-31 14:15:34,944|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,944|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,944|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,944|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,945|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,945|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,945|azureml._base_sdk_common.service_discovery|DEBUG|Found history service url in environment variable AZUREML_SERVICE_ENDPOINT, history service url: https://westeurope.experiments.azureml.net.\\n2020-08-31 14:15:34,950|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:34,951|azureml._run_impl.run_history_facade|DEBUG|Created a static thread pool for RunHistoryFacade class\\n2020-08-31 14:15:34,955|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:34,960|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:34,964|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:34,969|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:34,970|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.RunClient.get-async:False|DEBUG|[START]\\n2020-08-31 14:15:34,970|msrest.service_client|DEBUG|Accept header absent and forced to application/json\\n2020-08-31 14:15:34,970|msrest.http_logger|DEBUG|Request URL: 'https://westeurope.experiments.azureml.net/history/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runs/covid-training2_1598883241_77ea4914'\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|Request method: 'GET'\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|Request headers:\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|    'Accept': 'application/json'\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|    'Content-Type': 'application/json; charset=utf-8'\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '885a2e8c-5b7f-4765-a9be-d8e3a0f10458'\\n2020-08-31 14:15:34,971|msrest.http_logger|DEBUG|    'request-id': '885a2e8c-5b7f-4765-a9be-d8e3a0f10458'\\n2020-08-31 14:15:34,972|msrest.http_logger|DEBUG|    'User-Agent': 'python/3.6.2 (Linux-4.15.0-1092-azure-x86_64-with-debian-buster-sid) msrest/0.6.18 azureml._restclient/core.1.12.0 azureml-sdk-core/1.12.0'\\n2020-08-31 14:15:34,972|msrest.http_logger|DEBUG|Request body:\\n2020-08-31 14:15:34,972|msrest.http_logger|DEBUG|None\\n2020-08-31 14:15:34,972|msrest.universal_http|DEBUG|Configuring redirects: allow=True, max=30\\n2020-08-31 14:15:34,972|msrest.universal_http|DEBUG|Configuring request: timeout=100, verify=True, cert=None\\n2020-08-31 14:15:34,972|msrest.universal_http|DEBUG|Configuring proxies: ''\\n2020-08-31 14:15:34,972|msrest.universal_http|DEBUG|Evaluate proxies against ENV settings: True\\n2020-08-31 14:15:35,050|msrest.http_logger|DEBUG|Response status: 200\\n2020-08-31 14:15:35,050|msrest.http_logger|DEBUG|Response headers:\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Date': 'Mon, 31 Aug 2020 14:15:35 GMT'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Content-Type': 'application/json; charset=utf-8'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Transfer-Encoding': 'chunked'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Connection': 'keep-alive'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Vary': 'Accept-Encoding'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'Request-Context': 'appId=cid-v1:6a27ce65-5555-41a3-85f7-b7a1ce31fd6b'\\n2020-08-31 14:15:35,051|msrest.http_logger|DEBUG|    'x-ms-response-type': 'standard'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '885a2e8c-5b7f-4765-a9be-d8e3a0f10458'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'x-ms-client-session-id': ''\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'x-request-time': '0.049'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'Strict-Transport-Security': 'max-age=15724800; includeSubDomains; preload'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'X-Content-Type-Options': 'nosniff'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|    'Content-Encoding': 'gzip'\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|Response content:\\n2020-08-31 14:15:35,052|msrest.http_logger|DEBUG|{\\n  \\\"runNumber\\\": 2,\\n  \\\"rootRunId\\\": \\\"covid-training2_1598883241_77ea4914\\\",\\n  \\\"experimentId\\\": \\\"a4d0b257-40d8-42cc-85d0-b46f739c7b9f\\\",\\n  \\\"createdUtc\\\": \\\"2020-08-31T14:14:03.3603877+00:00\\\",\\n  \\\"createdBy\\\": {\\n    \\\"userObjectId\\\": \\\"dd31caf9-cba0-45cd-9562-950e2d57ea24\\\",\\n    \\\"userPuId\\\": \\\"10032000CF0AD7A6\\\",\\n    \\\"userIdp\\\": \\\"live.com\\\",\\n    \\\"userAltSecId\\\": \\\"1:live.com:00037FFE1E1C4C5E\\\",\\n    \\\"userIss\\\": \\\"https://sts.windows.net/53a2628b-019a-476a-96c2-6b7acc5973b8/\\\",\\n    \\\"userTenantId\\\": \\\"53a2628b-019a-476a-96c2-6b7acc5973b8\\\",\\n    \\\"userName\\\": \\\"Oscar Jaldo Amigo\\\"\\n  },\\n  \\\"userId\\\": \\\"dd31caf9-cba0-45cd-9562-950e2d57ea24\\\",\\n  \\\"token\\\": null,\\n  \\\"tokenExpiryTimeUtc\\\": null,\\n  \\\"error\\\": null,\\n  \\\"warnings\\\": null,\\n  \\\"revision\\\": 8,\\n  \\\"runUuid\\\": \\\"16896f19-a985-421d-a2db-ad86db833fb7\\\",\\n  \\\"parentRunUuid\\\": null,\\n  \\\"rootRunUuid\\\": \\\"16896f19-a985-421d-a2db-ad86db833fb7\\\",\\n  \\\"runId\\\": \\\"covid-training2_1598883241_77ea4914\\\",\\n  \\\"parentRunId\\\": null,\\n  \\\"status\\\": \\\"Running\\\",\\n  \\\"startTimeUtc\\\": \\\"2020-08-31T14:15:12.5638985+00:00\\\",\\n  \\\"endTimeUtc\\\": null,\\n  \\\"options\\\": {\\n    \\\"generateDataContainerIdIfNotSpecified\\\": true\\n  },\\n  \\\"name\\\": null,\\n  \\\"dataContainerId\\\": \\\"dcid.covid-training2_1598883241_77ea4914\\\",\\n  \\\"description\\\": null,\\n  \\\"hidden\\\": false,\\n  \\\"runType\\\": \\\"azureml.scriptrun\\\",\\n  \\\"properties\\\": {\\n    \\\"_azureml.ComputeTargetType\\\": \\\"amlcompute\\\",\\n    \\\"ContentSnapshotId\\\": \\\"83082e4e-0700-463a-b897-a1ca42f60b5a\\\",\\n    \\\"ProcessInfoFile\\\": \\\"azureml-logs/process_info.json\\\",\\n    \\\"ProcessStatusFile\\\": \\\"azureml-logs/process_status.json\\\"\\n  },\\n  \\\"scriptName\\\": \\\"covid_training_dense169.py\\\",\\n  \\\"target\\\": \\\"ci-eva3\\\",\\n  \\\"uniqueChildRunComputeTargets\\\": [],\\n  \\\"tags\\\": {\\n    \\\"_aml_system_ComputeTargetStatus\\\": \\\"{\\\\\\\"AllocationState\\\\\\\":\\\\\\\"steady\\\\\\\",\\\\\\\"PreparingNodeCount\\\\\\\":0,\\\\\\\"RunningNodeCount\\\\\\\":0,\\\\\\\"CurrentNodeCount\\\\\\\":1}\\\"\\n  },\\n  \\\"inputDatasets\\\": [],\\n  \\\"outputDatasets\\\": [],\\n  \\\"runDefinition\\\": null,\\n  \\\"createdFrom\\\": {\\n    \\\"type\\\": \\\"Notebook\\\",\\n    \\\"locationType\\\": \\\"ArtifactId\\\",\\n    \\\"location\\\": \\\"LocalUpload/covid-training2_1598883241_77ea4914/covid19_dense.ipynb\\\"\\n  },\\n  \\\"cancelUri\\\": \\\"https://westeurope.experiments.azureml.net/execution/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runId/covid-training2_1598883241_77ea4914/cancel\\\",\\n  \\\"completeUri\\\": null,\\n  \\\"diagnosticsUri\\\": \\\"https://westeurope.experiments.azureml.net/execution/v1.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/experiments/covid-training2/runId/covid-training2_1598883241_77ea4914/diagnostics\\\",\\n  \\\"computeRequest\\\": {\\n    \\\"nodeCount\\\": 1\\n  },\\n  \\\"retainForLifetimeOfWorkspace\\\": false,\\n  \\\"queueingInfo\\\": null\\n}\\n2020-08-31 14:15:35,055|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.RunClient.get-async:False|DEBUG|[STOP]\\n2020-08-31 14:15:35,056|azureml._SubmittedRun#covid-training2_1598883241_77ea4914|DEBUG|Constructing run from dto. type: azureml.scriptrun, source: None, props: {'_azureml.ComputeTargetType': 'amlcompute', 'ContentSnapshotId': '83082e4e-0700-463a-b897-a1ca42f60b5a', 'ProcessInfoFile': 'azureml-logs/process_info.json', 'ProcessStatusFile': 'azureml-logs/process_status.json'}\\n2020-08-31 14:15:35,057|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunContextManager|DEBUG|Valid logs dir, setting up content loader\\n2020-08-31 14:15:42,969|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient|DEBUG|Overrides: Max batch size: 50, batch cushion: 5, Interval: 1.\\n2020-08-31 14:15:42,969|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.PostMetricsBatchV2.PostMetricsBatchV2Daemon|DEBUG|Starting daemon and triggering first instance\\n2020-08-31 14:15:42,970|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient|DEBUG|Used <class 'azureml._common.async_utils.batch_task_queue.BatchTaskQueue'> for use_batch=True.\\n2020-08-31 14:15:43,971|azureml.BatchTaskQueueAdd_1_Batches|DEBUG|[Start]\\n2020-08-31 14:15:43,971|azureml.BatchTaskQueueAdd_1_Batches.WorkerPool|DEBUG|submitting future: _handle_batch\\n2020-08-31 14:15:43,972|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.PostMetricsBatchV2|DEBUG|Batch size 1.\\n2020-08-31 14:15:43,972|azureml.BatchTaskQueueAdd_1_Batches.0__handle_batch|DEBUG|Using basic handler - no exception handling\\n2020-08-31 14:15:43,972|azureml._restclient.clientbase.WorkerPool|DEBUG|submitting future: _log_batch_v2\\n2020-08-31 14:15:43,973|azureml.BatchTaskQueueAdd_1_Batches|DEBUG|Adding task 0__handle_batch to queue of approximate size: 0\\n2020-08-31 14:15:43,973|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.post_run_metrics-async:False|DEBUG|[START]\\n2020-08-31 14:15:43,973|azureml.BatchTaskQueueAdd_1_Batches|DEBUG|[Stop] - waiting default timeout\\n2020-08-31 14:15:43,974|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.PostMetricsBatchV2.0__log_batch_v2|DEBUG|Using basic handler - no exception handling\\n2020-08-31 14:15:43,975|msrest.service_client|DEBUG|Accept header absent and forced to application/json\\n2020-08-31 14:15:43,975|azureml.BatchTaskQueueAdd_1_Batches.WaitFlushSource:BatchTaskQueueAdd_1_Batches|DEBUG|[START]\\n2020-08-31 14:15:43,975|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.PostMetricsBatchV2|DEBUG|Adding task 0__log_batch_v2 to queue of approximate size: 0\\n2020-08-31 14:15:43,976|msrest.universal_http.requests|DEBUG|Configuring retry: max_retries=3, backoff_factor=0.8, max_backoff=90\\n2020-08-31 14:15:43,976|azureml.BatchTaskQueueAdd_1_Batches.WaitFlushSource:BatchTaskQueueAdd_1_Batches|DEBUG|Overriding default flush timeout from None to 120\\n2020-08-31 14:15:43,977|msrest.http_logger|DEBUG|Request URL: 'https://westeurope.experiments.azureml.net/metric/v2.0/subscriptions/03712800-fbe1-4639-81d1-4ebb18f06dfc/resourceGroups/RG-eva/providers/Microsoft.MachineLearningServices/workspaces/ws-eva/runs/covid-training2_1598883241_77ea4914/batch'\\n2020-08-31 14:15:43,977|azureml.BatchTaskQueueAdd_1_Batches.WaitFlushSource:BatchTaskQueueAdd_1_Batches|DEBUG|Waiting 120 seconds on tasks: [AsyncTask(0__handle_batch)].\\n2020-08-31 14:15:43,977|msrest.http_logger|DEBUG|Request method: 'POST'\\n2020-08-31 14:15:43,977|azureml.BatchTaskQueueAdd_1_Batches.0__handle_batch.WaitingTask|DEBUG|[START]\\n2020-08-31 14:15:43,978|msrest.http_logger|DEBUG|Request headers:\\n2020-08-31 14:15:43,978|azureml.BatchTaskQueueAdd_1_Batches.0__handle_batch.WaitingTask|DEBUG|Awaiter is BatchTaskQueueAdd_1_Batches\\n2020-08-31 14:15:43,978|msrest.http_logger|DEBUG|    'Accept': 'application/json'\\n2020-08-31 14:15:43,978|azureml.BatchTaskQueueAdd_1_Batches.0__handle_batch.WaitingTask|DEBUG|[STOP]\\n2020-08-31 14:15:43,978|msrest.http_logger|DEBUG|    'Content-Type': 'application/json-patch+json; charset=utf-8'\\n2020-08-31 14:15:43,978|azureml.BatchTaskQueueAdd_1_Batches|DEBUG|\\n2020-08-31 14:15:43,978|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '9dd9b5a1-c62d-4dfe-979d-44b7e998309b'\\n2020-08-31 14:15:43,978|azureml.BatchTaskQueueAdd_1_Batches.WaitFlushSource:BatchTaskQueueAdd_1_Batches|DEBUG|[STOP]\\n2020-08-31 14:15:43,979|msrest.http_logger|DEBUG|    'request-id': '9dd9b5a1-c62d-4dfe-979d-44b7e998309b'\\n2020-08-31 14:15:43,979|msrest.http_logger|DEBUG|    'Content-Length': '220'\\n2020-08-31 14:15:43,979|msrest.http_logger|DEBUG|    'User-Agent': 'python/3.6.2 (Linux-4.15.0-1092-azure-x86_64-with-debian-buster-sid) msrest/0.6.18 azureml._restclient/core.1.12.0 sdk_run'\\n2020-08-31 14:15:43,979|msrest.http_logger|DEBUG|Request body:\\n2020-08-31 14:15:43,979|msrest.http_logger|DEBUG|{\\\"values\\\": [{\\\"name\\\": \\\"model\\\", \\\"columns\\\": {}, \\\"value\\\": [{\\\"metricId\\\": \\\"cba4c50b-252f-406d-9b9b-e2e52c00a290\\\", \\\"createdUtc\\\": \\\"2020-08-31T14:15:42.969478Z\\\", \\\"data\\\": {}}], \\\"properties\\\": {\\\"uxMetricType\\\": \\\"azureml.v1.table\\\"}}]}\\n2020-08-31 14:15:43,979|msrest.universal_http|DEBUG|Configuring redirects: allow=True, max=30\\n2020-08-31 14:15:43,979|msrest.universal_http|DEBUG|Configuring request: timeout=100, verify=True, cert=None\\n2020-08-31 14:15:43,979|msrest.universal_http|DEBUG|Configuring proxies: ''\\n2020-08-31 14:15:43,979|msrest.universal_http|DEBUG|Evaluate proxies against ENV settings: True\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|Response status: 200\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|Response headers:\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'Date': 'Mon, 31 Aug 2020 14:15:44 GMT'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'Content-Length': '0'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'Connection': 'keep-alive'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'Request-Context': 'appId=cid-v1:6a27ce65-5555-41a3-85f7-b7a1ce31fd6b'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'x-ms-response-type': 'standard'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'x-ms-client-request-id': '9dd9b5a1-c62d-4dfe-979d-44b7e998309b'\\n2020-08-31 14:15:44,231|msrest.http_logger|DEBUG|    'x-ms-client-session-id': ''\\n2020-08-31 14:15:44,232|msrest.http_logger|DEBUG|    'x-request-time': '0.233'\\n2020-08-31 14:15:44,232|msrest.http_logger|DEBUG|    'Strict-Transport-Security': 'max-age=15724800; includeSubDomains; preload'\\n2020-08-31 14:15:44,232|msrest.http_logger|DEBUG|    'X-Content-Type-Options': 'nosniff'\\n2020-08-31 14:15:44,232|msrest.http_logger|DEBUG|Response content:\\n2020-08-31 14:15:44,232|msrest.http_logger|DEBUG|\\n2020-08-31 14:15:44,233|azureml._SubmittedRun#covid-training2_1598883241_77ea4914.RunHistoryFacade.MetricsClient.post_run_metrics-async:False|DEBUG|[STOP]\\n2020-08-31 14:16:01,142|azureml.core.authentication|DEBUG|Time to expire 1814281.857554 seconds\\n2020-08-31 14:16:31,143|azureml.core.authentication|DEBUG|Time to expire 1814251.85703 seconds\\n2020-08-31 14:17:01,143|azureml.core.authentication|DEBUG|Time to expire 1814221.85653 seconds\\n2020-08-31 14:17:31,144|azureml.core.authentication|DEBUG|Time to expire 1814191.856005 seconds\\n2020-08-31 14:18:01,144|azureml.core.authentication|DEBUG|Time to expire 1814161.855599 seconds\\n2020-08-31 14:18:31,144|azureml.core.authentication|DEBUG|Time to expire 1814131.855313 seconds\\n2020-08-31 14:19:01,145|azureml.core.authentication|DEBUG|Time to expire 1814101.854899 seconds\\n2020-08-31 14:19:31,145|azureml.core.authentication|DEBUG|Time to expire 1814071.854443 seconds\\n2020-08-31 14:20:01,146|azureml.core.authentication|DEBUG|Time to expire 1814041.854027 seconds\\n2020-08-31 14:20:31,146|azureml.core.authentication|DEBUG|Time to expire 1814011.853802 seconds\\n2020-08-31 14:21:01,146|azureml.core.authentication|DEBUG|Time to expire 1813981.853429 seconds\\n2020-08-31 14:21:31,147|azureml.core.authentication|DEBUG|Time to expire 1813951.852908 seconds\\n2020-08-31 14:22:01,147|azureml.core.authentication|DEBUG|Time to expire 1813921.852761 seconds\\n2020-08-31 14:22:31,147|azureml.core.authentication|DEBUG|Time to expire 1813891.852183 seconds\\n2020-08-31 14:23:01,148|azureml.core.authentication|DEBUG|Time to expire 1813861.851832 seconds\\n\", \"graph\": {}, \"widget_settings\": {\"childWidgetDisplay\": \"popup\", \"send_telemetry\": false, \"log_level\": \"INFO\", \"sdk_version\": \"1.12.0\"}, \"loading\": false}"
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "from azureml.train.estimator import Estimator\n",
    "from azureml.train.dnn import TensorFlow\n",
    "from azureml.core import Experiment\n",
    "from azureml.widgets import RunDetails\n",
    "\n",
    "# Set up the parameters\n",
    "script_params = {\n",
    "    '--epochs': 1,   \n",
    "    '--batch_size': 32,    \n",
    "    '--n_1layer': 256,        \n",
    "    '--n_2layer': 123,\n",
    "    '--learning-rate': 0.001,\n",
    "}\n",
    "\n",
    "# Create an estimator\n",
    "\n",
    "estimator = TensorFlow(source_directory=training_folder,                                            \n",
    "                      entry_script='covid_training_dense169.py',                      \n",
    "                      script_params=script_params,\n",
    "                      compute_target='ci-eva3',\n",
    "                      conda_packages=['keras','matplotlib','scikit-learn'],                      \n",
    "                      framework_version='2.0'                                \n",
    "                      )\n",
    "# Create an experiment\n",
    "experiment_name = 'covid-training2'\n",
    "experiment = Experiment(workspace = ws, name = experiment_name)\n",
    "\n",
    "# Run the experiment based on the estimator\n",
    "run = experiment.submit(config=estimator)\n",
    "RunDetails(run).show()\n",
    "run.wait_for_completion()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Get logged metrics\n",
    "metrics = run.get_metrics()\n",
    "for key in metrics.keys():\n",
    "        print(key, metrics.get(key))\n",
    "print('\\n')\n",
    "for file in run.get_file_names():\n",
    "    print(file)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
